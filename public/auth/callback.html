<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https: wss:; frame-ancestors 'self';"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Signing you in…</title>
    <style>
      html,body{height:100%}body{display:flex;align-items:center;justify-content:center;font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial}
      .box{max-width:520px;padding:24px;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.06)}
      .muted{opacity:.7}
    </style>
  </head>
  <body>
    <div class="box">
      <div><strong>Naturverse</strong></div>
      <p class="muted">Completing sign-in…</p>
      <noscript>Enable JavaScript to continue.</noscript>
    </div>

    <script>
      (function () {
        try {
          // Parse the fragment (#foo=bar&baz=qux)
          const frag = (location.hash || '').replace(/^#/, '');
          const params = new URLSearchParams(frag);

          // Common Supabase fields
          const access_token  = params.get('access_token');
          const refresh_token = params.get('refresh_token');
          const token_type    = params.get('token_type');
          const expires_in    = params.get('expires_in');

          // Persist for your app to pick up on /
          if (access_token) {
            // Keep keys namespaced to avoid collisions
            localStorage.setItem('nv.sb.access_token',  access_token);
            if (refresh_token) localStorage.setItem('nv.sb.refresh_token', refresh_token);
            if (token_type)    localStorage.setItem('nv.sb.token_type',    token_type);
            if (expires_in)    localStorage.setItem('nv.sb.expires_in',    expires_in);

            // If opener is available (popup flow), notify it
            try { window.opener && window.opener.postMessage({ nvAuth: 'ok' }, location.origin); } catch (_) {}
          } else {
            // Surface something useful for debugging
            localStorage.setItem('nv.sb.callback_debug', frag || '(no fragment)');
          }
        } catch (err) {
          localStorage.setItem('nv.sb.callback_error', String(err && err.message || err));
        } finally {
          // Always end on the app shell
          location.replace('/');
        }
      })();
    </script>
  </body>
</html>
