[build]
command = "npm run build"
publish = "dist"
functions = "netlify/functions"

# 1) Only the real callback path is handled by the SPA shell
[[redirects]]
from = "/auth/callback"
to = "/index.html"
status = 200
force = true

# 2) Never rewrite real static assets (important!)
[[redirects]]
from = "/assets/*"
to   = "/assets/:splat"
status = 200

# Some older builds might have emitted /auth/assets â€” keep them public too
[[redirects]]
from = "/auth/assets/*"
to   = "/auth/assets/:splat"
status = 200

# 3) SPA fallback for the rest
[[redirects]]
from = "/*"
to   = "/index.html"
status = 200
force = true

# Relaxed but safe CSP for auth & API calls (no inline scripts)
[[headers]]
for = "/*"
  [headers.values]
  Content-Security-Policy = """
    default-src 'self';
    script-src 'self' https://*.supabase.co https://accounts.google.com;
    connect-src 'self' https://*.supabase.co https://accounts.google.com https://*.stripe.com;
    img-src 'self' data: blob:;
    style-src 'self' 'unsafe-inline';
    frame-src https://accounts.google.com;
    frame-ancestors 'self';
    base-uri 'self'
  """
  Referrer-Policy = "strict-origin-when-cross-origin"
  X-Content-Type-Options = "nosniff"
  X-Frame-Options = "SAMEORIGIN"
